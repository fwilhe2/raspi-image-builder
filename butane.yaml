variant: fcos
version: 1.4.0
passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - ssh-rsa AAAA...
systemd:
  units:
    - name: rpm-ostree-install-k3s-selinux.service
      enabled: true
      contents: |
        [Unit]
        Description=Layer k3s-selinux with rpm-ostree
        Wants=network-online.target
        After=network-online.target
        # We run before `zincati.service` to avoid conflicting rpm-ostree
        # transactions.
        Before=zincati.service
        ConditionPathExists=!/var/lib/%N.stamp

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/bin/rpm-ostree install --apply-live https://github.com/k3s-io/k3s-selinux/releases/download/v1.1.stable.1/k3s-selinux-1.1-1.el8.noarch.rpm
        ExecStart=/bin/touch /var/lib/%N.stamp

        [Install]
        WantedBy=multi-user.target
    - name: install-k3s.service
      enabled: true
      contents: |
        [Unit]
        Description=install k3s
        Wants=network-online.target
        After=zincati.service
        ConditionPathExists=!/var/lib/rancher/k3s

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/bin/sh -c 'curl -sfL https://get.k3s.io | sh -s - --disable=traefik --disable=servicelb --flannel-backend=host-gw --flannel-iface=enp0s20u1'

        [Install]
        WantedBy=multi-user.target
storage:
  files:
    - path: /etc/hostname
      mode: 0644
      contents:
        inline: |
          routernetes
    - path: /etc/NetworkManager/system-connections/enp0s20u1.nmconnection
      mode: 0600
      contents:
        inline: |
          [connection]
          id=enp0s20u1
          type=ethernet
          interface-name=enp0s20u1
          [ipv4]
          address1=10.0.0.1/24
          method=manual
    - path: /etc/zincati/config.d/55-updates-strategy.toml
      contents:
        inline: |
          [updates]
          strategy = "periodic"

          [updates.periodic]
          time_zone = "America/Edmonton"

          [[updates.periodic.window]]
          days = [ "Sun" ]
          start_time = "04:00"
          length_minutes = 60
    - path: /usr/share/dbus-1/system.d/FirewallD.conf
      contents:
        inline: |
          <?xml version="1.0" encoding="UTF-8"?> <!-- -*- XML -*- -->

          <!DOCTYPE busconfig PUBLIC
          "-//freedesktop//DTD D-BUS Bus Configuration 1.0//EN"
          "http://www.freedesktop.org/standards/dbus/1.0/busconfig.dtd">
          <busconfig>

            <!-- Only root can own the service and send signals -->
            <policy user="root">
              <allow own="org.fedoraproject.FirewallD1"/>
              <allow own="org.fedoraproject.FirewallD1.config"/>
              <allow send_destination="org.fedoraproject.FirewallD1"/>
              <allow send_destination="org.fedoraproject.FirewallD1.config"/>
            </policy>

            <!-- Allow anyone to invoke methods on the interfaces,
                authorization is performed by PolicyKit -->
            <policy context="default">
              <allow send_destination="org.fedoraproject.FirewallD1"/>
              <allow send_destination="org.fedoraproject.FirewallD1"
                    send_interface="org.freedesktop.DBus.Introspectable"/>
              <allow send_destination="org.fedoraproject.FirewallD1"
                    send_interface="org.freedesktop.DBus.Properties"/>
              <allow send_destination="org.fedoraproject.FirewallD1.config"/>
            </policy>

          </busconfig>
